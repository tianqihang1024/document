



## `MySQL`的事务满足`ACID`

- A：原子性，指事务必须被看作执行的最小单元，事务的操作要不都执行，要不全部不执行
- C：一致性，数据库总是从一个一致性状态转移到另一个一致性状态
- I：隔离性，一个事务的执行不能不能干扰到其他事务，也不能被其他事务干扰
- D：持久性，事务一旦提交，对记录的修改是永久性的，哪怕数据库重启



## 原子性



## 一致性



## 隔离性

事务的隔离性有`MVCC`和读写锁保证

- `MVCC`，多版本并发控制，解决读写下事务的隔离性
- 读写锁，`InnoDB`有表锁、行锁、间隙锁、临键锁，解决写写下事务的隔离性

### `MVCC`

- 版本链

    ​		对于`InnoDB`来说，聚簇索引中有两个隐藏信息，事务`id`和回滚指针。

    ​		`trx_id`：每次事务对某条聚簇索引操作时，都会当前事务的事务`id`赋值给`trx_id`隐藏列（修改性质的事务才会这么做，因为有只读事务情况存在）

    ​		`roll_pointer`：对聚簇索引修改时，将旧值放到一条`undo`日志中，通过回滚指针可以找到修改前的信息，算是这条记录的旧版本，随着写次数的增加，所有版本会通过回滚指针形成一个链表，在`review`中会有用到（旧值包括记录本身、事务`id`、回滚指针）

- `read view`

    ​		隔离级别的核心概念是如何让对应的事务看到自己应该看的。`read uncommitted`下直接查看最新版本就行、`serializable`下所有事务串行执行，不需要考虑什么事务。`read commintted`和`repeatable read`需要看到已经提交了的数据，如果记录尚为提交是不能被看到的（并不追求最新版本），`MySQL`采用`read view`读视图来实现，有几个重要的属性。
    
    1. `m_ids`：生成读视图时，系统中活跃的所有读写事务`id`列表。
    2. `min_trx_id`：生成读视图时，系统中活跃的最小事务`id`。
    3. `max_trx_id`：生成读视图时，下一个即将分配的事务`id`。
    4. `creator_trx_id`：生成本视图的事务`id`。
    
    ​		小贴士：前面说过，只有对记录修改时（insert、update、delete）才会分配递增的事务`id`，否则一个读事务他的事务`id`是一个很大的随机值、比现存所有的事务`id`都大得多。
    
- 结合

    有了这个`read view`，当要访问一条记录时，只需要按照步骤判断记录的哪个版本是可见的，以此实现读写状态下不同事务间的隔离性。

    1. 访问版本的`trx_id`与`ReadView`中的`creator_trx_id`相同，表示正在访问自己修改过的数据，可见。
    2. 访问版本的`trx_id`小于`ReadView`中的`min_trx_id`，表明当前版本在生成快照时已经提交，可见。
    3. 访问版本的`trx_id`大于等于`ReadView`中的`max_trx_id`，表明当前版本开始时间晚于`ReadView`，不可见。
    4. 访问版本的`trx_id`在`ReadView`的`min_trx_id`和`max_trx_id`之间，就需要判断是否存在与`m_ids`列表中，存在的话表示当前版本尚未提交，不可见。不存在的话表示修改的数据已经提交，可见。

​			小贴士：如果某个版本的数据对当前事务不可见的话，那就顺着版本链找到下一个版本的数据，继续按照上边的步骤判断可见性，依此类推，直到版本链	中的最后一个版本。如果最后一个版本也不可见的话，那么就意味着该条记录对该事务完全不可见，查询结果就不包含该记录。

- 总结

    ​		所谓的`MVCC（Multi-Version Concurrency Control ，多版本并发控制）`指的就是在使用`Read-Committed`、`Repeated-Read`，这两种隔离级别的事务时，执行普通的`SELECT`操作时访问记录版本链的过程，这样子可以使不同事务的读-写、写-读操作并发执行，从而提升系统性能。`Read-Committed`和`Repeated-Read`这两个隔离级别的一个很大不同就是：生成 `ReadView`的时机不同，Read-Committed在每一次进行普通SELECT操作前都会生成一个`ReadView`，而Repeated-Read只在第一次进行普通SELECT操作前生成一个`ReadView`，之后的查询操作都重复使用这个`ReadView`



### 读写锁（for update）

​		关键字 `for update`，用于









## 持久性









































